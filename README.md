


# DIANN 蛋白质组学数据模块化分析流程

这是一个为 DIANN 设计的、高度模块化和智能化的分析流程，专门用于处理数据非依赖性采集 (DIA) 模式下的标签自由定量 (Label-Free Quantification, LFQ) 蛋白质组学数据。本流程从 DIANN 的原始输出报告出发，通过一系列自动化的【模块】，完成数据预处理、质量控制、统计分析、功能富集，并能一键生成最终的分析报告。

该流程的核心特性是**配置与逻辑分离**以及**智能化执行**，用户只需在唯一的**【总控制面板】**中定义实验设计，后续所有分析模块将自动适应不同的数据情况（如单组 vs. 多组，重复数变化），选择最合适的分析策略。

## ✨ 项目特性 (Features)

*   **🕹️ 集中式配置**: 所有参数（文件路径、样本分组、统计阈值等）均在一个总控制面板中设置，无需修改核心代码。
*   **🧠 智能化分析**: 流程能自动识别实验设计（单组/多组），并执行最恰当的分析组合。
*   **🧩 完全模块化**: 每个分析步骤（QC、差异分析、富集分析等）都是一个独立的、可插拔的模块。
*   **🛡️ 健壮的错误处理**: 能够智能处理文件缺失、不满足分析条件等情况，通过警告而非报错来保证流程的顺利运行。
*   **🔬 专业级QC**: 集成了变异系数(CV)分析等定量QC指标，并能根据重复数自动选择韦恩图或Upset图。
*   **📊 数据归一化**: 内置可选的中位数归一化模块，用于校正系统性技术偏差，提升数据可比性。
*   **📜 一键生成报告**: （可选）能够将整个分析过程和结果一键导出为干净、专业的HTML报告。

## 📁 项目结构

```
.
├── data/               # 存放原始数据文件。
│   └── raw_data/       # DIANN 输出的原始报告文件（.tsv, .parquet）。
├── results/            # 存放所有分析结果，包括生成的图表和最终报告。
├── scripts/            # 存放所有的分析代码。
│   └── preprocessing/  # 主要的 Jupyter Notebook 分析文件。
├── LICENSE             # 项目许可证文件。
└── README.md           # 项目说明文件。
```

## 🚀 快速开始 (Quick Start)

### 1. 环境设置

建议在虚拟环境 (如 Conda) 中进行安装，以避免包版本冲突。

```bash
# 克隆仓库
git clone https://github.com/Jasper-delong/DIANN_Data_Preprocessing.git  # 【请修改】为您的仓库链接
cd DIANN_Data_Preprocessing

# 安装所有必需的 Python 库
pip install pandas matplotlib seaborn scikit-learn pyarrow jupyterlab
pip install matplotlib-venn upsetplot gseapy nbconvert
```

### 2. 准备数据

将您的 DIANN 输出文件（特别是 `report.pg_matrix.tsv`, `report.pr_matrix.tsv` 和 `report.parquet`）放入 `/data/raw_data` 文件夹。

### 3. 配置与运行

1.  打开 `/scripts/preprocessing/` 文件夹中的主分析 Notebook (例如 `preprocessing.ipynb`)。
2.  **仔细编辑【总控制面板】单元格**:
    *   **文件路径**: 确认 `PROJECT_ROOT_DIR` 设置正确。
    *   **样本与分组**:
        *   在 `COLUMN_MAPPING` 中，将您原始的长文件名**精确地**映射为您想要的短名称。
        *   在 `GROUP_DEFINITIONS` 中，使用这些短名称定义您的实验组。
    *   **分析参数**:
        *   设置 `PERFORM_NORMALIZATION = True` 以激活数据归一化（推荐）。
        *   在 `COMPARISON_PAIRS` 中定义您想要进行差异比较的组对，例如 `[('Model', 'Control')]`。如果只有一组，请保持为 `[]`。
        *   根据需要调整 `P_VALUE_THRESHOLD` 和 `LOG2_FC_THRESHOLD`。
3.  **按顺序执行所有单元格**: 从顶部菜单栏选择 `Kernel -> Restart & Run All`，或按顺序手动运行每个模块的单元格。

## 🔬 分析模块详解 (Analysis Modules)

本流程由一系列独立的、顺序执行的模块构成：

### 【模块一】数据加载、预处理与归一化
*   **状态**: ✅ 已完成
*   **功能**:
    *   **智能加载**: 自动检测并加载【总控制面板】中定义的所有存在的文件。
    *   **预处理**: 执行索引设置、样本重命名和污染物移除。
    *   **数据归一化**: （可选）执行中位数归一化，并通过“归一化前后”的箱线图直观展示校正效果。
    *   **透明化**: 详细打印每一步的处理过程和数据预览，让流程不再是“黑箱”。

### 【模块二】智能QC分析 (带CV分析)
*   **状态**: ✅ 已完成
*   **功能**:
    *   **智能决策**: 自动判断是**单组分析**（评估重复性）还是**多组分析**（评估组内聚集与组间分离）。
    *   **定量QC**: 生成相关性热图、PCA图、箱线图。
    *   **定性QC**: 根据重复数自动选择**韦恩图 (≤3)** 或 **Upset图 (>3)**。
    *   **CV分析**: 新增变异系数(CV)分布图，提供衡量重复性的**定量指标**。

### 【模块三】差异表达分析
*   **状态**: ✅ 已完成
*   **功能**:
    *   **条件化执行**: 仅在【总控制面板】中定义了 `COMPARISON_PAIRS` 时激活。
    *   **核心统计**: 为每一对比较，通过T检验计算 **p-value** 和 **Log2 Fold Change**。
    *   **结果输出**: 生成一个包含所有统计结果的字典，供下游模块使用。

### 【模块四】差异结果可视化
*   **状态**: ✅ 已完成
*   **功能**:
    *   **条件化执行**: 仅在【模块三】成功产生差异分析结果时激活。
    *   **核心图表**: 为每一对比较，自动生成**火山图 (Volcano Plot)**和**聚类热图 (Clustered Heatmap)**。

### 【模块五】智能功能分析
*   **状态**: ✅ 已完成
*   **功能**:
    *   **智能决策**:
        *   **多组**: 对差异蛋白（上调/下调）进行 **GO & KEGG 差异富集分析**。
        *   **单组**: 对该组鉴定到的**所有**蛋白质进行 **GO & KEGG 整体功能轮廓分析**。
    *   **可视化**: 使用信息量丰富的**点图 (Dot Plot)**展示富集结果。

### 【模块六 & 七】报告生成 (可选)
*   **状态**: 🚧 实验性 (搁置)
*   **功能**: 提供将整个 Notebook 一键导出为干净HTML报告的功能。

## 作者
*   **judeong** 
*   **联系方式**: judelong@genomics.cn
*   **GitHub**: Jasper-delong(https://github.com/Jasper-delong)